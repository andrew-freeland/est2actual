<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Results - {{ intelligent_title or project_name }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fas fa-chart-line text-blue-600 text-2xl mr-3"></i>
                    <span class="text-xl font-bold text-gray-900">Estimate Insight</span>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="flex items-center text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium transition">
                        <i class="fas fa-plus-circle mr-2"></i>
                        New Analysis
                    </a>
                    <a href="/patterns" class="flex items-center text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium transition">
                        <i class="fas fa-analytics mr-2"></i>
                        View Patterns
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- Success Banner -->
        <div class="mb-8 bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded-lg shadow-sm fade-in flex items-center">
            <i class="fas fa-check-circle text-2xl mr-3"></i>
            <div>
                <p class="font-bold">Analysis Complete!</p>
                <p class="text-sm">Your variance analysis has been generated successfully.</p>
            </div>
        </div>

        <!-- Project Header -->
        <div class="mb-8 fade-in">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">{{ intelligent_title or project_name }}</h1>
            <p class="text-gray-600">Estimate vs. Actual Cost Analysis</p>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 fade-in">
            <!-- Total Variance -->
            <div class="bg-white rounded-lg shadow-lg p-6 border-l-4 {% if summary.total_variance > 0 %}border-red-500{% else %}border-green-500{% endif %}">
                <div class="text-sm font-medium text-gray-600 mb-1">Total Variance</div>
                <div class="text-3xl font-bold {% if summary.total_variance > 0 %}text-red-600{% else %}text-green-600{% endif %}">
                    ${{ "{:,.0f}".format(summary.total_variance|default(0)) }}
                </div>
                <div class="text-xs text-gray-500 mt-2">
                    {{ "{:.1f}".format(summary.total_variance_pct|default(0)) }}%
                    {% if summary.total_variance > 0 %}
                        <span class="text-red-600">over budget</span>
                    {% else %}
                        <span class="text-green-600">under budget</span>
                    {% endif %}
                </div>
            </div>

            <!-- Total Estimated -->
            <div class="bg-white rounded-lg shadow-lg p-6 border-l-4 border-blue-500">
                <div class="text-sm font-medium text-gray-600 mb-1">Total Estimated</div>
                <div class="text-3xl font-bold text-blue-600">
                    ${{ "{:,.0f}".format(summary.total_estimated|default(0)) }}
                </div>
                <div class="text-xs text-gray-500 mt-2">Original budget</div>
            </div>

            <!-- Total Actual -->
            <div class="bg-white rounded-lg shadow-lg p-6 border-l-4 border-purple-500">
                <div class="text-sm font-medium text-gray-600 mb-1">Total Actual</div>
                <div class="text-3xl font-bold text-purple-600">
                    ${{ "{:,.0f}".format(summary.total_actual|default(0)) }}
                </div>
                <div class="text-xs text-gray-500 mt-2">Final spend</div>
            </div>

            <!-- Categories -->
            <div class="bg-white rounded-lg shadow-lg p-6 border-l-4 border-indigo-500">
                <div class="text-sm font-medium text-gray-600 mb-1">Categories</div>
                <div class="text-3xl font-bold text-indigo-600">
                    {{ variance_data|length }}
                </div>
                <div class="text-xs text-gray-500 mt-2">Line items analyzed</div>
            </div>
        </div>

        <!-- Category Matching Section -->
        {% if category_mapping %}
        <div class="mb-8 bg-white rounded-lg shadow-xl overflow-hidden fade-in">
            <div class="bg-gradient-to-r from-teal-500 to-cyan-600 px-6 py-4 flex items-center">
                <i class="fas fa-code-branch text-3xl mr-3 text-white"></i>
                <h2 class="text-2xl font-bold text-white">Category Matching Report</h2>
            </div>
            
            <div class="p-8">
                <p class="text-gray-700 mb-6">
                    This shows how categories from your Estimate report (e.g., Buildertrend export) were matched to categories in your Actual report (e.g., QuickBooks export).
                </p>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded">
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-600 text-2xl mr-3"></i>
                            <div>
                                <div class="text-sm text-gray-600">Matched Categories</div>
                                <div class="text-3xl font-bold text-green-700">{{ category_mapping.match_summary.total_matched }}</div>
                                <div class="text-xs text-gray-500 mt-1">Found in both reports</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded">
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-triangle text-yellow-600 text-2xl mr-3"></i>
                            <div>
                                <div class="text-sm text-gray-600">Estimate Only</div>
                                <div class="text-3xl font-bold text-yellow-700">{{ category_mapping.match_summary.total_estimate_only }}</div>
                                <div class="text-xs text-gray-500 mt-1">Budgeted but not spent</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-orange-50 border-l-4 border-orange-500 p-4 rounded">
                        <div class="flex items-center">
                            <i class="fas fa-surprise text-orange-600 text-2xl mr-3"></i>
                            <div>
                                <div class="text-sm text-gray-600">Actual Only</div>
                                <div class="text-3xl font-bold text-orange-700">{{ category_mapping.match_summary.total_actual_only }}</div>
                                <div class="text-xs text-gray-500 mt-1">Unbudgeted spending</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <div class="flex items-center">
                        <i class="fas fa-percentage text-blue-600 text-xl mr-3"></i>
                        <div>
                            <span class="text-sm text-gray-600">Match Rate: </span>
                            <span class="text-xl font-bold text-blue-700">{{ "%.0f"|format(category_mapping.match_summary.match_rate_pct|default(0)) }}%</span>
                            <span class="text-xs text-gray-500 ml-2">of estimate categories found in actual report</span>
                        </div>
                    </div>
                </div>
                
                {% if category_mapping.estimate_only_categories|length > 0 %}
                <div class="mt-4">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-file-invoice text-yellow-600 mr-2"></i>Budgeted but Not Spent:
                    </h3>
                    <div class="bg-yellow-50 rounded p-3 text-sm text-gray-700">
                        {% for cat in category_mapping.estimate_only_categories[:5] %}
                            <span class="inline-block bg-yellow-200 px-2 py-1 rounded mr-2 mb-2">{{ cat.category }}</span>
                        {% endfor %}
                        {% if category_mapping.estimate_only_categories|length > 5 %}
                            <span class="text-gray-500">... and {{ category_mapping.estimate_only_categories|length - 5 }} more</span>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                {% if category_mapping.actual_only_categories|length > 0 %}
                <div class="mt-4">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-money-bill-wave text-orange-600 mr-2"></i>Unbudgeted Spending:
                    </h3>
                    <div class="bg-orange-50 rounded p-3 text-sm text-gray-700">
                        {% for cat in category_mapping.actual_only_categories[:5] %}
                            <span class="inline-block bg-orange-200 px-2 py-1 rounded mr-2 mb-2">{{ cat.category }}</span>
                        {% endfor %}
                        {% if category_mapping.actual_only_categories|length > 5 %}
                            <span class="text-gray-500">... and {{ category_mapping.actual_only_categories|length - 5 }} more</span>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Memory Status & Pattern Detection -->
        {% if memory_id %}
        <div class="mb-8 bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-lg shadow-md fade-in">
            <div class="flex items-start">
                <i class="fas fa-database text-2xl mr-3"></i>
                <div>
                    <p class="font-bold">Saved to Memory</p>
                    <p class="text-sm">Analysis ID: <code class="bg-blue-200 px-2 py-1 rounded">{{ memory_id }}</code></p>
                    {% if pattern_detection_enabled %}
                    <p class="text-sm mt-1">
                        Pattern detection enabled: Found {{ similar_projects_count }} similar past project(s)
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- AI Insight Section -->
        <div class="bg-white rounded-lg shadow-xl overflow-hidden mb-8 fade-in">
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 px-6 py-4 flex items-center">
                <i class="fas fa-robot text-3xl mr-3 text-white"></i>
                <h2 class="text-2xl font-bold text-white">AI-Generated Insight</h2>
            </div>
            
            <div class="p-8">
                <div class="prose prose-lg max-w-none">
                    <div class="text-gray-800 leading-relaxed whitespace-pre-line">{{ narrative }}</div>
                </div>
                
                <!-- Feedback Section -->
                <div class="mt-6 border-t border-gray-200 pt-6">
                    <div class="feedback-container" data-insight-id="{{ memory_id or project_name }}" data-feedback-type="detailed">
                        <!-- Feedback Toggle Button -->
                        <button 
                            onclick="toggleFeedback('ai-insight-feedback')"
                            class="flex items-center text-sm text-gray-600 hover:text-blue-600 transition font-medium"
                        >
                            <i class="fas fa-chevron-right transition-transform mr-2" id="arrow-ai-insight-feedback"></i>
                            <span>Provide Feedback on this Insight</span>
                        </button>
                        
                        <!-- Expandable Feedback Form -->
                        <div id="ai-insight-feedback" class="hidden mt-4 bg-gray-50 rounded-lg p-4 border border-gray-200">
                            <p class="text-sm text-gray-600 mb-3">Help us improve our AI insights:</p>
                            
                            <!-- Rating Buttons -->
                            <div class="flex gap-3 mb-4">
                                <button 
                                    onclick="setRating('ai-insight-feedback', 'thumbs_up')"
                                    class="rating-btn flex items-center gap-2 px-4 py-2 border-2 border-gray-300 rounded-lg hover:border-green-500 hover:bg-green-50 transition"
                                    data-rating="thumbs_up"
                                >
                                    <i class="fas fa-thumbs-up text-lg"></i>
                                    <span class="font-medium">Helpful</span>
                                </button>
                                <button 
                                    onclick="setRating('ai-insight-feedback', 'thumbs_down')"
                                    class="rating-btn flex items-center gap-2 px-4 py-2 border-2 border-gray-300 rounded-lg hover:border-red-500 hover:bg-red-50 transition"
                                    data-rating="thumbs_down"
                                >
                                    <i class="fas fa-thumbs-down text-lg"></i>
                                    <span class="font-medium">Not Helpful</span>
                                </button>
                            </div>
                            
                            <!-- Detailed Feedback Text -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Additional Comments (Optional):
                                </label>
                                <textarea 
                                    class="feedback-text w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    rows="3"
                                    placeholder="Tell us more about your experience..."
                                ></textarea>
                            </div>
                            
                            <!-- Submit Button -->
                            <button 
                                onclick="submitFeedback('ai-insight-feedback')"
                                class="submit-feedback-btn px-6 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled
                            >
                                Submit Feedback
                            </button>
                            
                            <!-- Success Message -->
                            <div class="feedback-success hidden mt-3 p-3 bg-green-100 text-green-800 rounded-lg flex items-center">
                                <i class="fas fa-check-circle mr-2"></i>
                                <span class="text-sm">Thank you for your feedback!</span>
                            </div>
                            
                            <!-- Error Message -->
                            <div class="feedback-error hidden mt-3 p-3 bg-red-100 text-red-800 rounded-lg flex items-center">
                                <i class="fas fa-exclamation-circle mr-2"></i>
                                <span class="text-sm">Failed to submit feedback. Please try again.</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart Visualization -->
        {% if chart_image_base64 %}
        <div class="bg-white rounded-lg shadow-xl overflow-hidden mb-8 fade-in">
            <div class="bg-gradient-to-r from-blue-500 to-cyan-600 px-6 py-4 flex items-center">
                <i class="fas fa-chart-bar text-3xl mr-3 text-white"></i>
                <h2 class="text-2xl font-bold text-white">Variance Visualization</h2>
            </div>
            
            <div class="p-8">
                <img 
                    src="data:image/png;base64,{{ chart_image_base64 }}" 
                    alt="Variance Chart" 
                    class="w-full rounded-lg shadow-md"
                >
                <p class="text-sm text-gray-500 mt-4 text-center">
                    Red bars indicate over budget, green bars indicate under budget
                </p>
            </div>
        </div>
        {% endif %}

        <!-- Variance Data Table - Grouped View -->
        <div class="bg-white rounded-lg shadow-xl overflow-hidden mb-8 fade-in">
            <div class="bg-gradient-to-r from-gray-600 to-gray-800 px-6 py-4 flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fas fa-layer-group text-3xl mr-3 text-white"></i>
                    <h2 class="text-2xl font-bold text-white">Category Breakdown</h2>
                </div>
                <span class="text-sm text-gray-300">Click categories to expand line items</span>
            </div>
            
            <div class="divide-y divide-gray-200">
                {% if grouped_variance %}
                    {% for group in grouped_variance %}
                    <div class="category-group">
                        <!-- Category Header (Collapsible) -->
                        <div class="category-header cursor-pointer hover:bg-gray-50 transition"
                             onclick="toggleCategory('category-{{ loop.index }}')"
                             data-category-id="category-{{ loop.index }}">
                            <div class="flex items-center justify-between px-6 py-4">
                                <div class="flex items-center space-x-4 flex-1">
                                    <!-- Expand/Collapse Icon -->
                                    <i class="fas fa-chevron-right category-arrow transition-transform text-gray-400" 
                                       id="arrow-category-{{ loop.index }}"></i>
                                    
                                    <!-- Category Name -->
                                    <div>
                                        <div class="font-bold text-gray-900">{{ group.category }}</div>
                                        <div class="text-xs text-gray-500 mt-1">
                                            {{ group.line_item_count }} line item{% if group.line_item_count != 1 %}s{% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Category Totals -->
                                <div class="flex space-x-6 text-sm">
                                    <div class="text-right">
                                        <div class="text-xs text-gray-500 uppercase">Estimated</div>
                                        <div class="font-semibold text-blue-600">${{ "{:,.0f}".format(group.estimated) }}</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xs text-gray-500 uppercase">Actual</div>
                                        <div class="font-semibold text-purple-600">${{ "{:,.0f}".format(group.actual) }}</div>
                                    </div>
                                    <div class="text-right min-w-[120px]">
                                        <div class="text-xs text-gray-500 uppercase">Variance</div>
                                        <div class="font-bold text-lg {% if group.variance > 0 %}text-red-600{% elif group.variance < 0 %}text-green-600{% else %}text-gray-600{% endif %}">
                                            ${{ "{:,.0f}".format(group.variance) }}
                                            <span class="text-sm">({{ "{:.1f}".format(group.variance_pct) }}%)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Line Items (Hidden by Default) -->
                        <div id="category-{{ loop.index }}" class="category-items hidden bg-gray-50">
                            <div class="px-6 py-4">
                                <table class="min-w-full">
                                    <thead>
                                        <tr class="text-xs text-gray-500 uppercase">
                                            <th class="text-left pb-2">Line Item</th>
                                            <th class="text-right pb-2">Estimated</th>
                                            <th class="text-right pb-2">Actual</th>
                                            <th class="text-right pb-2">Variance</th>
                                            <th class="text-right pb-2">%</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200">
                                        {% for item in group.line_items %}
                                        <tr class="text-sm">
                                            <td class="py-2 text-gray-700">
                                                {{ item.Category }}
                                            </td>
                                            <td class="py-2 text-right text-gray-600">
                                                ${{ "{:,.2f}".format(item.Estimated) }}
                                            </td>
                                            <td class="py-2 text-right text-gray-600">
                                                ${{ "{:,.2f}".format(item.Actual) }}
                                            </td>
                                            <td class="py-2 text-right font-semibold
                                                {% if item.Variance > 0 %}text-red-600{% elif item.Variance < 0 %}text-green-600{% else %}text-gray-600{% endif %}">
                                                ${{ "{:,.2f}".format(item.Variance) }}
                                            </td>
                                            <td class="py-2 text-right
                                                {% if item['Variance_%'] > 0 %}text-red-600{% elif item['Variance_%'] < 0 %}text-green-600{% else %}text-gray-600{% endif %}">
                                                {{ "{:.1f}".format(item['Variance_%']) }}%
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <!-- Fallback to ungrouped view if grouped_variance not available -->
                    <div class="p-6">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Estimated</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actual</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Variance</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">%</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for row in variance_data %}
                                <tr>
                                    <td class="px-6 py-4 text-sm text-gray-900">{{ row.Category }}</td>
                                    <td class="px-6 py-4 text-sm text-right text-gray-600">${{ "{:,.2f}".format(row.Estimated) }}</td>
                                    <td class="px-6 py-4 text-sm text-right text-gray-600">${{ "{:,.2f}".format(row.Actual) }}</td>
                                    <td class="px-6 py-4 text-sm text-right font-semibold
                                        {% if row.Variance > 0 %}text-red-600{% elif row.Variance < 0 %}text-green-600{% endif %}">
                                        ${{ "{:,.2f}".format(row.Variance) }}
                                    </td>
                                    <td class="px-6 py-4 text-sm text-right
                                        {% if row['Variance_%'] > 0 %}text-red-600{% elif row['Variance_%'] < 0 %}text-green-600{% endif %}">
                                        {{ "{:.1f}".format(row['Variance_%']) }}%
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
                
                <!-- Total Footer -->
                <div class="bg-gray-100 px-6 py-4 font-bold border-t-2 border-gray-300">
                    <div class="flex items-center justify-between">
                        <div class="text-gray-900">TOTAL</div>
                        <div class="flex space-x-6 text-sm">
                            <div class="text-right">
                                <div class="text-xs text-gray-500 uppercase">Estimated</div>
                                <div class="font-bold text-blue-600">${{ "{:,.0f}".format(summary.total_estimated) }}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-gray-500 uppercase">Actual</div>
                                <div class="font-bold text-purple-600">${{ "{:,.0f}".format(summary.total_actual) }}</div>
                            </div>
                            <div class="text-right min-w-[120px]">
                                <div class="text-xs text-gray-500 uppercase">Variance</div>
                                <div class="font-bold text-xl {% if summary.total_variance > 0 %}text-red-600{% elif summary.total_variance < 0 %}text-green-600{% else %}text-gray-600{% endif %}">
                                    ${{ "{:,.0f}".format(summary.total_variance) }}
                                    <span class="text-sm">({{ "{:.1f}".format(summary.total_variance_pct) }}%)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
        function toggleCategory(categoryId) {
            const items = document.getElementById(categoryId);
            const arrow = document.getElementById('arrow-' + categoryId);
            
            if (items.classList.contains('hidden')) {
                items.classList.remove('hidden');
                arrow.classList.add('rotate-90');
            } else {
                items.classList.add('hidden');
                arrow.classList.remove('rotate-90');
            }
        }
        </script>

        <!-- Highest Variance Categories -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 fade-in">
            <!-- Biggest Over-Budget -->
            {% if summary.biggest_overrun %}
            <div class="bg-white rounded-lg shadow-lg p-6 border-t-4 border-red-500">
                <h3 class="text-lg font-bold text-red-600 mb-4 flex items-center">
                    <i class="fas fa-arrow-trend-up text-2xl mr-2"></i>
                    Biggest Over-Budget
                </h3>
                <div class="space-y-2">
                    <div class="text-2xl font-bold text-gray-900">{{ summary.biggest_overrun.Category|default('N/A') }}</div>
                    <div class="text-3xl font-bold text-red-600">
                        +${{ "{:,.0f}".format(summary.biggest_overrun.Variance|default(0)) }}
                    </div>
                    <div class="text-sm text-gray-600">
                        {{ "{:.1f}".format(summary.biggest_overrun['Variance_%']|default(0)) }}% over estimate
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Biggest Under-Budget -->
            {% if summary.biggest_underrun %}
            <div class="bg-white rounded-lg shadow-lg p-6 border-t-4 border-green-500">
                <h3 class="text-lg font-bold text-green-600 mb-4 flex items-center">
                    <i class="fas fa-arrow-trend-down text-2xl mr-2"></i>
                    Biggest Under-Budget
                </h3>
                <div class="space-y-2">
                    <div class="text-2xl font-bold text-gray-900">{{ summary.biggest_underrun.Category|default('N/A') }}</div>
                    <div class="text-3xl font-bold text-green-600">
                        ${{ "{:,.0f}".format(summary.biggest_underrun.Variance|default(0)) }}
                    </div>
                    <div class="text-sm text-gray-600">
                        {{ "{:.1f}".format(summary.biggest_underrun['Variance_%']|default(0)) }}% under estimate
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-center space-x-4 mb-8 fade-in">
            <a href="/" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition flex items-center">
                <i class="fas fa-redo mr-2"></i>
                Analyze Another Project
            </a>
            <a href="/patterns" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition flex items-center">
                <i class="fas fa-analytics mr-2"></i>
                View All Patterns
            </a>
        </div>
    </main>

    <!-- Footer -->
    <footer class="mt-16 bg-white border-t border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-6">
                <!-- About -->
                <div>
                    <div class="flex items-center mb-3">
                        <i class="fas fa-chart-line text-blue-600 text-xl mr-2"></i>
                        <span class="font-semibold text-gray-900">Profit Analysis Tool</span>
                    </div>
                    <p class="text-gray-600 text-sm">
                        AI-powered cost variance analysis for construction professionals.
                    </p>
                </div>

                <!-- Compatible With -->
                <div>
                    <h3 class="text-sm font-semibold text-gray-900 mb-3">Compatible With</h3>
                    <div class="space-y-2">
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-file-export text-blue-600 mr-2 text-xs"></i>
                            <span>Buildertrend Exports</span>
                        </div>
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-file-invoice text-blue-600 mr-2 text-xs"></i>
                            <span>QuickBooks Exports</span>
                        </div>
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-file-excel text-blue-600 mr-2 text-xs"></i>
                            <span>Excel/CSV Files</span>
                        </div>
                    </div>
                </div>

                <!-- Quick Links -->
                <div>
                    <h3 class="text-sm font-semibold text-gray-900 mb-3">Navigation</h3>
                    <ul class="space-y-2">
                        <li><a href="/" class="text-gray-600 hover:text-blue-600 text-sm transition">Home</a></li>
                        <li><a href="/patterns" class="text-gray-600 hover:text-blue-600 text-sm transition">View Patterns</a></li>
                    </ul>
                </div>
            </div>

            <!-- Technology & Copyright -->
            <div class="border-t border-gray-200 pt-6">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex flex-wrap items-center gap-4 text-xs text-gray-500">
                        <span>Powered by Google Vertex AI Gemini 1.5 Pro</span>
                        <span class="hidden md:inline">•</span>
                        <span>Cloud Run</span>
                        <span class="hidden md:inline">•</span>
                        <span>Firestore</span>
                    </div>
                    <p class="text-sm text-gray-500">
                        © 2025 Builder's Business Partner LLC
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Feedback state storage
        const feedbackStates = {};
        
        // Toggle feedback form visibility
        function toggleFeedback(feedbackId) {
            const form = document.getElementById(feedbackId);
            const arrow = document.getElementById('arrow-' + feedbackId);
            
            if (form.classList.contains('hidden')) {
                form.classList.remove('hidden');
                arrow.classList.add('rotate-90');
            } else {
                form.classList.add('hidden');
                arrow.classList.remove('rotate-90');
            }
        }
        
        // Set rating and enable submit button
        function setRating(feedbackId, rating) {
            const form = document.getElementById(feedbackId);
            const buttons = form.querySelectorAll('.rating-btn');
            const submitBtn = form.querySelector('.submit-feedback-btn');
            
            // Update button states
            buttons.forEach(btn => {
                if (btn.dataset.rating === rating) {
                    // Selected state
                    if (rating === 'thumbs_up') {
                        btn.classList.add('border-green-500', 'bg-green-100', 'text-green-700');
                        btn.classList.remove('border-gray-300');
                    } else {
                        btn.classList.add('border-red-500', 'bg-red-100', 'text-red-700');
                        btn.classList.remove('border-gray-300');
                    }
                } else {
                    // Unselected state
                    btn.classList.remove('border-green-500', 'bg-green-100', 'text-green-700');
                    btn.classList.remove('border-red-500', 'bg-red-100', 'text-red-700');
                    btn.classList.add('border-gray-300');
                }
            });
            
            // Store rating and enable submit
            if (!feedbackStates[feedbackId]) {
                feedbackStates[feedbackId] = {};
            }
            feedbackStates[feedbackId].rating = rating;
            submitBtn.disabled = false;
        }
        
        // Submit feedback to server
        async function submitFeedback(feedbackId) {
            const form = document.getElementById(feedbackId);
            const container = form.closest('.feedback-container');
            const insightId = container.dataset.insightId;
            const feedbackType = container.dataset.feedbackType;
            const feedbackText = form.querySelector('.feedback-text').value;
            const submitBtn = form.querySelector('.submit-feedback-btn');
            const successMsg = form.querySelector('.feedback-success');
            const errorMsg = form.querySelector('.feedback-error');
            
            // Get rating
            const rating = feedbackStates[feedbackId]?.rating;
            if (!rating) {
                return;
            }
            
            // Disable submit button during request
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            
            // Hide previous messages
            successMsg.classList.add('hidden');
            errorMsg.classList.add('hidden');
            
            try {
                const response = await fetch('/submit_feedback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        insight_id: insightId,
                        feedback_type: feedbackType,
                        rating: rating,
                        feedback_text: feedbackText,
                        metadata: {
                            page: 'result',
                            timestamp: new Date().toISOString()
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show success message
                    successMsg.classList.remove('hidden');
                    
                    // Disable form after successful submission
                    submitBtn.textContent = 'Submitted';
                    form.querySelector('.feedback-text').disabled = true;
                    form.querySelectorAll('.rating-btn').forEach(btn => {
                        btn.disabled = true;
                        btn.classList.add('opacity-50', 'cursor-not-allowed');
                    });
                } else {
                    // Show error message
                    errorMsg.classList.remove('hidden');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Feedback';
                }
            } catch (error) {
                console.error('Error submitting feedback:', error);
                errorMsg.classList.remove('hidden');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Feedback';
            }
        }
        
        // Add print functionality
        window.onload = function() {
            // Optional: Add print button dynamically
            console.log('Results page loaded successfully');
        };
    </script>
</body>
</html>

